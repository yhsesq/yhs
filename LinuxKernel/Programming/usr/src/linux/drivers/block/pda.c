/*
 *  linux/drivers/block/pda.c
 *
 *  Written by Zurk Tech, 12/30/98
 *
 * Copyright 1998,1999 by Zurk Tech.  Redistribution of this file is
 * permitted under the GNU Public License.
 *
 * Still To Fix:
 *
 */

#include <linux/module.h>
#include <linux/sched.h>
#include <linux/fs.h>
#include <linux/file.h>
#include <linux/stat.h>
#include <linux/errno.h>
#include <linux/major.h>
#include <linux/init.h>
#include <asm/uaccess.h>
#include <linux/pda.h>

#define MAJOR_NR PDA_MAJOR
#define DEVICE_NAME "pda"
#define DEVICE_REQUEST do_pda_request
#define DEVICE_NR(device) (MINOR(device))
#define DEVICE_ON(device)
#define DEVICE_OFF(device)
#define DEVICE_NO_RANDOM
#include <linux/blk.h>

#define MAX_PDA 1
static struct pda_device pda_dev[MAX_PDA];
static int pda_sizes[MAX_PDA];
static int pda_blksizes[MAX_PDA];
// static int pda_maxsectors[MAX_PDA];
// static int pda_hardsect[MAX_PDA];
#define FALSE 0
#define TRUE (!FALSE)

#define MAX_DISK_SIZE 1024
char array[1024];

static int pda_open(struct inode *inode, struct file *file)
{
        int     dev;
	struct pda_device *pda;

        if (!inode)  return -EINVAL;
        if (MAJOR(inode->i_rdev) != MAJOR_NR) {
  printk(KERN_WARNING "pda: pda_open() pseudo-major != %d\n", MAJOR_NR);
                return -ENODEV; }
        dev = MINOR(inode->i_rdev);
        if (dev >= MAX_PDA) {  return -ENODEV; }
	pda=&pda_dev[dev];
	pda->pda_refcnt++;
  printk(KERN_INFO "pda: pda_open() now opening remote device. \n");
  printk(KERN_INFO "pda: pda_open() cannot open PDA. Mounting romfs. \n");

// File system kludging. Generate a fake romfs filesystem.
// This is debugging/test code only. 
array[0]=45;
array[1]=114;
array[2]=111;
array[3]=109;
array[4]=49;
array[5]=102;
array[6]=115;
array[7]=45;
array[8]=0;
array[9]=0;
array[10]=3;
array[11]=-64;
array[12]=49;
array[13]=-25;
array[14]=-12;
array[15]=27;
array[16]=80;
array[17]=68;
array[18]=65;
array[19]=58;
array[20]=101;
array[21]=114;
array[22]=114;
array[23]=111;
array[24]=114;
array[25]=0;
array[26]=0;
array[27]=0;
array[28]=0;
array[29]=0;
array[30]=0;
array[31]=0;
array[32]=0;
array[33]=0;
array[34]=0;
array[35]=73;
array[36]=0;
array[37]=0;
array[38]=0;
array[39]=32;
array[40]=0;
array[41]=0;
array[42]=0;
array[43]=0;
array[44]=-47;
array[45]=-1;
array[46]=-1;
array[47]=-105;
array[48]=46;
array[49]=0;
array[50]=0;
array[51]=0;
array[52]=0;
array[53]=0;
array[54]=0;
array[55]=0;
array[56]=0;
array[57]=0;
array[58]=0;
array[59]=0;
array[60]=0;
array[61]=0;
array[62]=0;
array[63]=0;
array[64]=0;
array[65]=0;
array[66]=0;
array[67]=96;
array[68]=0;
array[69]=0;
array[70]=0;
array[71]=32;
array[72]=0;
array[73]=0;
array[74]=0;
array[75]=0;
array[76]=-47;
array[77]=-47;
array[78]=-1;
array[79]=-128;
array[80]=46;
array[81]=46;
array[82]=0;
array[83]=0;
array[84]=0;
array[85]=0;
array[86]=0;
array[87]=0;
array[88]=0;
array[89]=0;
array[90]=0;
array[91]=0;
array[92]=0;
array[93]=0;
array[94]=0;
array[95]=0;
array[96]=0;
array[97]=0;
array[98]=1;
array[99]=2;
array[100]=0;
array[101]=0;
array[102]=0;
array[103]=0;
array[104]=0;
array[105]=0;
array[106]=0;
array[107]=114;
array[108]=107;
array[109]=103;
array[110]=-78;
array[111]=83;
array[112]=99;
array[113]=111;
array[114]=110;
array[115]=110;
array[116]=101;
array[117]=99;
array[118]=116;
array[119]=95;
array[120]=102;
array[121]=97;
array[122]=105;
array[123]=108;
array[124]=101;
array[125]=100;
array[126]=0;
array[127]=0;
array[128]=84;
array[129]=104;
array[130]=105;
array[131]=115;
array[132]=32;
array[133]=102;
array[134]=105;
array[135]=108;
array[136]=101;
array[137]=115;
array[138]=121;
array[139]=115;
array[140]=116;
array[141]=101;
array[142]=109;
array[143]=32;
array[144]=105;
array[145]=115;
array[146]=32;
array[147]=98;
array[148]=117;
array[149]=105;
array[150]=108;
array[151]=116;
array[152]=32;
array[153]=105;
array[154]=110;
array[155]=116;
array[156]=111;
array[157]=32;
array[158]=116;
array[159]=104;
array[160]=101;
array[161]=32;
array[162]=103;
array[163]=101;
array[164]=110;
array[165]=101;
array[166]=114;
array[167]=105;
array[168]=99;
array[169]=32;
array[170]=80;
array[171]=68;
array[172]=65;
array[173]=32;
array[174]=100;
array[175]=114;
array[176]=105;
array[177]=118;
array[178]=101;
array[179]=114;
array[180]=46;
array[181]=32;
array[182]=10;
array[183]=73;
array[184]=116;
array[185]=32;
array[186]=105;
array[187]=110;
array[188]=100;
array[189]=105;
array[190]=99;
array[191]=97;
array[192]=116;
array[193]=101;
array[194]=115;
array[195]=32;
array[196]=116;
array[197]=104;
array[198]=101;
array[199]=32;
array[200]=100;
array[201]=114;
array[202]=105;
array[203]=118;
array[204]=101;
array[205]=114;
array[206]=32;
array[207]=104;
array[208]=97;
array[209]=115;
array[210]=32;
array[211]=102;
array[212]=97;
array[213]=105;
array[214]=108;
array[215]=101;
array[216]=100;
array[217]=32;
array[218]=116;
array[219]=111;
array[220]=32;
array[221]=99;
array[222]=111;
array[223]=110;
array[224]=110;
array[225]=101;
array[226]=99;
array[227]=116;
array[228]=32;
array[229]=116;
array[230]=111;
array[231]=32;
array[232]=121;
array[233]=111;
array[234]=117;
array[235]=114;
array[236]=32;
array[237]=80;
array[238]=68;
array[239]=65;
array[240]=46;
array[241]=10;
array[242]=84;
array[243]=104;
array[244]=105;
array[245]=115;
array[246]=32;
array[247]=102;
array[248]=105;
array[249]=108;
array[250]=101;
array[251]=115;
array[252]=121;
array[253]=115;
array[254]=116;
array[255]=101;
array[256]=0;
array[257]=0;
array[258]=0;
array[259]=2;
array[260]=0;
array[261]=0;
array[262]=0;
array[263]=0;
array[264]=0;
array[265]=0;
array[266]=2;
array[267]=-97;
array[268]=-80;
array[269]=-56;
array[270]=7;
array[271]=22;
array[272]=114;
array[273]=101;
array[274]=97;
array[275]=100;
array[276]=109;
array[277]=101;
array[278]=46;
array[279]=114;
array[280]=111;
array[281]=109;
array[282]=102;
array[283]=115;
array[284]=0;
array[285]=0;
array[286]=0;
array[287]=0;
array[288]=71;
array[289]=101;
array[290]=110;
array[291]=101;
array[292]=114;
array[293]=105;
array[294]=99;
array[295]=32;
array[296]=80;
array[297]=68;
array[298]=65;
array[299]=32;
array[300]=68;
array[301]=114;
array[302]=105;
array[303]=118;
array[304]=101;
array[305]=114;
array[306]=32;
array[307]=102;
array[308]=111;
array[309]=114;
array[310]=32;
array[311]=76;
array[312]=105;
array[313]=110;
array[314]=117;
array[315]=120;
array[316]=10;
array[317]=45;
array[318]=45;
array[319]=45;
array[320]=45;
array[321]=45;
array[322]=45;
array[323]=45;
array[324]=45;
array[325]=45;
array[326]=45;
array[327]=45;
array[328]=45;
array[329]=45;
array[330]=45;
array[331]=45;
array[332]=45;
array[333]=45;
array[334]=45;
array[335]=45;
array[336]=45;
array[337]=45;
array[338]=45;
array[339]=45;
array[340]=45;
array[341]=45;
array[342]=45;
array[343]=45;
array[344]=45;
array[345]=10;
array[346]=10;
array[347]=84;
array[348]=104;
array[349]=105;
array[350]=115;
array[351]=32;
array[352]=105;
array[353]=115;
array[354]=32;
array[355]=116;
array[356]=104;
array[357]=101;
array[358]=32;
array[359]=105;
array[360]=110;
array[361]=105;
array[362]=116;
array[363]=105;
array[364]=97;
array[365]=108;
array[366]=32;
array[367]=82;
array[368]=79;
array[369]=77;
array[370]=32;
array[371]=102;
array[372]=105;
array[373]=108;
array[374]=101;
array[375]=115;
array[376]=121;
array[377]=115;
array[378]=116;
array[379]=101;
array[380]=109;
array[381]=32;
array[382]=99;
array[383]=114;
array[384]=101;
array[385]=97;
array[386]=116;
array[387]=101;
array[388]=100;
array[389]=32;
array[390]=98;
array[391]=121;
array[392]=32;
array[393]=116;
array[394]=104;
array[395]=101;
array[396]=32;
array[397]=100;
array[398]=114;
array[399]=105;
array[400]=118;
array[401]=101;
array[402]=114;
array[403]=32;
array[404]=105;
array[405]=102;
array[406]=32;
array[407]=105;
array[408]=116;
array[409]=10;
array[410]=102;
array[411]=97;
array[412]=105;
array[413]=108;
array[414]=115;
array[415]=32;
array[416]=116;
array[417]=111;
array[418]=32;
array[419]=99;
array[420]=111;
array[421]=110;
array[422]=110;
array[423]=101;
array[424]=99;
array[425]=116;
array[426]=32;
array[427]=116;
array[428]=111;
array[429]=32;
array[430]=121;
array[431]=111;
array[432]=117;
array[433]=114;
array[434]=32;
array[435]=80;
array[436]=68;
array[437]=65;
array[438]=46;
array[439]=32;
array[440]=89;
array[441]=111;
array[442]=117;
array[443]=32;
array[444]=109;
array[445]=117;
array[446]=115;
array[447]=116;
array[448]=32;
array[449]=114;
array[450]=117;
array[451]=110;
array[452]=32;
array[453]=116;
array[454]=104;
array[455]=101;
array[456]=32;
array[457]=80;
array[458]=68;
array[459]=65;
array[460]=45;
array[461]=115;
array[462]=112;
array[463]=101;
array[464]=99;
array[465]=105;
array[466]=102;
array[467]=105;
array[468]=99;
array[469]=32;
array[470]=10;
array[471]=100;
array[472]=114;
array[473]=105;
array[474]=118;
array[475]=101;
array[476]=114;
array[477]=32;
array[478]=111;
array[479]=110;
array[480]=32;
array[481]=121;
array[482]=111;
array[483]=117;
array[484]=114;
array[485]=32;
array[486]=80;
array[487]=68;
array[488]=65;
array[489]=32;
array[490]=98;
array[491]=101;
array[492]=102;
array[493]=111;
array[494]=114;
array[495]=101;
array[496]=32;
array[497]=109;
array[498]=111;
array[499]=117;
array[500]=110;
array[501]=116;
array[502]=105;
array[503]=110;
array[504]=103;
array[505]=32;
array[506]=105;
array[507]=116;
array[508]=32;
array[509]=117;
array[510]=115;
array[511]=105;
array[512]=110;
array[513]=103;
array[514]=32;
array[515]=116;
array[516]=104;
array[517]=101;
array[518]=32;
array[519]=71;
array[520]=101;
array[521]=110;
array[522]=101;
array[523]=114;
array[524]=105;
array[525]=99;
array[526]=32;
array[527]=80;
array[528]=68;
array[529]=65;
array[530]=10;
array[531]=100;
array[532]=101;
array[533]=118;
array[534]=105;
array[535]=99;
array[536]=101;
array[537]=46;
array[538]=32;
array[539]=73;
array[540]=102;
array[541]=32;
array[542]=121;
array[543]=111;
array[544]=117;
array[545]=32;
array[546]=100;
array[547]=111;
array[548]=32;
array[549]=110;
array[550]=111;
array[551]=116;
array[552]=44;
array[553]=32;
array[554]=111;
array[555]=114;
array[556]=32;
array[557]=105;
array[558]=102;
array[559]=32;
array[560]=116;
array[561]=104;
array[562]=101;
array[563]=32;
array[564]=99;
array[565]=111;
array[566]=110;
array[567]=110;
array[568]=101;
array[569]=99;
array[570]=116;
array[571]=105;
array[572]=111;
array[573]=110;
array[574]=32;
array[575]=102;
array[576]=97;
array[577]=105;
array[578]=108;
array[579]=115;
array[580]=32;
array[581]=102;
array[582]=111;
array[583]=114;
array[584]=32;
array[585]=115;
array[586]=111;
array[587]=109;
array[588]=101;
array[589]=10;
array[590]=114;
array[591]=101;
array[592]=97;
array[593]=115;
array[594]=111;
array[595]=110;
array[596]=44;
array[597]=32;
array[598]=116;
array[599]=104;
array[600]=105;
array[601]=115;
array[602]=32;
array[603]=100;
array[604]=105;
array[605]=115;
array[606]=107;
array[607]=47;
array[608]=102;
array[609]=105;
array[610]=108;
array[611]=101;
array[612]=32;
array[613]=105;
array[614]=115;
array[615]=32;
array[616]=97;
array[617]=117;
array[618]=116;
array[619]=111;
array[620]=109;
array[621]=97;
array[622]=116;
array[623]=105;
array[624]=99;
array[625]=97;
array[626]=108;
array[627]=108;
array[628]=121;
array[629]=32;
array[630]=109;
array[631]=111;
array[632]=117;
array[633]=110;
array[634]=116;
array[635]=101;
array[636]=100;
array[637]=46;
array[638]=32;
array[639]=10;
array[640]=10;
array[641]=70;
array[642]=111;
array[643]=114;
array[644]=32;
array[645]=116;
array[646]=104;
array[647]=101;
array[648]=32;
array[649]=108;
array[650]=97;
array[651]=116;
array[652]=101;
array[653]=115;
array[654]=116;
array[655]=32;
array[656]=100;
array[657]=114;
array[658]=105;
array[659]=118;
array[660]=101;
array[661]=114;
array[662]=32;
array[663]=97;
array[664]=110;
array[665]=100;
array[666]=32;
array[667]=117;
array[668]=112;
array[669]=100;
array[670]=97;
array[671]=116;
array[672]=101;
array[673]=115;
array[674]=32;
array[675]=58;
array[676]=10;
array[677]=10;
array[678]=104;
array[679]=116;
array[680]=116;
array[681]=112;
array[682]=58;
array[683]=47;
array[684]=47;
array[685]=109;
array[686]=101;
array[687]=109;
array[688]=98;
array[689]=101;
array[690]=114;
array[691]=115;
array[692]=46;
array[693]=116;
array[694]=114;
array[695]=105;
array[696]=112;
array[697]=111;
array[698]=100;
array[699]=46;
array[700]=99;
array[701]=111;
array[702]=109;
array[703]=47;
array[704]=126;
array[705]=122;
array[706]=117;
array[707]=114;
array[708]=107;
array[709]=108;
array[710]=105;
array[711]=110;
array[712]=103;
array[713]=32;
array[714]=111;
array[715]=114;
array[716]=10;
array[717]=104;
array[718]=116;
array[719]=116;
array[720]=112;
array[721]=58;
array[722]=47;
array[723]=47;
array[724]=115;
array[725]=117;
array[726]=114;
array[727]=102;
array[728]=46;
array[729]=116;
array[730]=111;
array[731]=47;
array[732]=122;
array[733]=117;
array[734]=114;
array[735]=107;
array[736]=10;
array[737]=10;
array[738]=69;
array[739]=109;
array[740]=97;
array[741]=105;
array[742]=108;
array[743]=32;
array[744]=58;
array[745]=32;
array[746]=10;
array[747]=10;
array[748]=122;
array[749]=117;
array[750]=114;
array[751]=107;
array[752]=64;
array[753]=103;
array[754]=101;
array[755]=111;
array[756]=99;
array[757]=105;
array[758]=116;
array[759]=105;
array[760]=101;
array[761]=115;
array[762]=46;
array[763]=99;
array[764]=111;
array[765]=109;
array[766]=10;
array[767]=10;
array[768]=45;
array[769]=45;
array[770]=45;
array[771]=45;
array[772]=45;
array[773]=45;
array[774]=45;
array[775]=45;
array[776]=45;
array[777]=45;
array[778]=45;
array[779]=45;
array[780]=45;
array[781]=45;
array[782]=45;
array[783]=45;
array[784]=45;
array[785]=45;
array[786]=10;
array[787]=71;
array[788]=101;
array[789]=110;
array[790]=101;
array[791]=114;
array[792]=105;
array[793]=99;
array[794]=32;
array[795]=80;
array[796]=68;
array[797]=65;
array[798]=32;
array[799]=100;
array[800]=114;
array[801]=105;
array[802]=118;
array[803]=101;
array[804]=114;
array[805]=32;
array[806]=10;
array[807]=40;
array[808]=67;
array[809]=41;
array[810]=32;
array[811]=49;
array[812]=57;
array[813]=57;
array[814]=56;
array[815]=45;
array[816]=49;
array[817]=57;
array[818]=57;
array[819]=57;
array[820]=32;
array[821]=90;
array[822]=117;
array[823]=114;
array[824]=107;
array[825]=32;
array[826]=84;
array[827]=101;
array[828]=99;
array[829]=104;
array[830]=110;
array[831]=111;
array[832]=108;
array[833]=111;
array[834]=103;
array[835]=121;
array[836]=32;
array[837]=73;
array[838]=110;
array[839]=99;
array[840]=46;
array[841]=10;
array[842]=84;
array[843]=104;
array[844]=105;
array[845]=115;
array[846]=32;
array[847]=100;
array[848]=114;
array[849]=105;
array[850]=118;
array[851]=101;
array[852]=114;
array[853]=32;
array[854]=105;
array[855]=115;
array[856]=32;
array[857]=114;
array[858]=101;
array[859]=108;
array[860]=101;
array[861]=97;
array[862]=115;
array[863]=101;
array[864]=100;
array[865]=32;
array[866]=117;
array[867]=110;
array[868]=100;
array[869]=101;
array[870]=114;
array[871]=32;
array[872]=116;
array[873]=104;
array[874]=101;
array[875]=32;
array[876]=116;
array[877]=101;
array[878]=114;
array[879]=109;
array[880]=115;
array[881]=32;
array[882]=111;
array[883]=102;
array[884]=32;
array[885]=116;
array[886]=104;
array[887]=101;
array[888]=32;
array[889]=10;
array[890]=71;
array[891]=78;
array[892]=85;
array[893]=32;
array[894]=71;
array[895]=80;
array[896]=76;
array[897]=32;
array[898]=40;
array[899]=104;
array[900]=116;
array[901]=116;
array[902]=112;
array[903]=58;
array[904]=47;
array[905]=47;
array[906]=119;
array[907]=119;
array[908]=119;
array[909]=46;
array[910]=103;
array[911]=110;
array[912]=117;
array[913]=46;
array[914]=111;
array[915]=114;
array[916]=103;
array[917]=41;
array[918]=46;
array[919]=10;
array[920]=82;
array[921]=101;
array[922]=108;
array[923]=101;
array[924]=97;
array[925]=115;
array[926]=101;
array[927]=100;
array[928]=32;
array[929]=58;
array[930]=32;
array[931]=49;
array[932]=47;
array[933]=49;
array[934]=47;
array[935]=49;
array[936]=57;
array[937]=57;
array[938]=57;
array[939]=10;
array[940]=45;
array[941]=45;
array[942]=45;
array[943]=45;
array[944]=45;
array[945]=45;
array[946]=45;
array[947]=45;
array[948]=45;
array[949]=45;
array[950]=45;
array[951]=45;
array[952]=45;
array[953]=45;
array[954]=45;
array[955]=45;
array[956]=45;
array[957]=45;
array[958]=10;
array[959]=71;
array[960]=0;
array[961]=0;
array[962]=0;
array[963]=0;
array[964]=0;
array[965]=0;
array[966]=0;
array[967]=0;
array[968]=0;
array[969]=0;
array[970]=0;
array[971]=0;
array[972]=0;
array[973]=0;
array[974]=0;
array[975]=0;
array[976]=0;
array[977]=0;
array[978]=0;
array[979]=0;
array[980]=0;
array[981]=0;
array[982]=0;
array[983]=0;
array[984]=0;
array[985]=0;
array[986]=0;
array[987]=0;
array[988]=0;
array[989]=0;
array[990]=0;
array[991]=0;
array[992]=0;
array[993]=0;
array[994]=0;
array[995]=0;
array[996]=0;
array[997]=0;
array[998]=0;
array[999]=0;
array[1000]=0;
array[1001]=0;
array[1002]=0;
array[1003]=0;
array[1004]=0;
array[1005]=0;
array[1006]=0;
array[1007]=0;
array[1008]=0;
array[1009]=0;
array[1010]=0;
array[1011]=0;
array[1012]=0;
array[1013]=0;
array[1014]=0;
array[1015]=0;
array[1016]=0;
array[1017]=0;
array[1018]=0;
array[1019]=0;
array[1020]=0;
array[1021]=0;
array[1022]=0;
array[1023]=0;
array[1024]=-1;
// end File System kludging.

        MOD_INC_USE_COUNT;
        return 0;
}

static void do_pda_request(void)
{
	struct request *current_request;

repeat:
	INIT_REQUEST;
	current_request=CURRENT;
	CURRENT=current_request->next;
	if (MINOR(current_request->rq_dev) >= MAX_PDA)
		goto error_out;
	if (current_request->cmd == WRITE) {
			goto error_out;
	} else if (current_request->cmd != READ) {
		printk(KERN_ERR "pda: unknown pda device command (%d)?!?",current_request->cmd);
		goto error_out;
	}
        if (current_request->cmd == READ)	{
	spin_unlock_irq(&io_request_lock);
        printk("pda: request %p: cmd %i sec %li (nr. %li), next %p\n",current_request,
               current_request->cmd,
               current_request->sector,
               current_request->current_nr_sectors,
               current_request->next);
	memcpy(current_request->buffer, (char *)&array[0], 1024 );
	spin_lock_irq(&io_request_lock);
						}
	current_request->next=CURRENT;
	CURRENT=current_request;
	end_request(1);
	goto repeat;
error_out:
	current_request->next=CURRENT;
	CURRENT=current_request;
	end_request(0);
	goto repeat;
}

static int pda_release(struct inode *inode, struct file *file)
{
        struct  pda_device *pda;
        int     dev, err;

        if (!inode)
                return 0;
        if (MAJOR(inode->i_rdev) != MAJOR_NR) {
                printk(KERN_WARNING "pda: pda_release() pseudo-major != %d\n", MAJOR_NR);
                return 0;
        }
        dev = MINOR(inode->i_rdev);
        if (dev >= MAX_PDA)
                return 0;
        err = fsync_dev(inode->i_rdev);
        pda = &pda_dev[dev];
        if (pda->pda_refcnt <= 0)
                printk(KERN_ERR "pda: pda_release() refcount(%d) <= 0\n", pda->pda_refcnt);
        else  {
                --pda->pda_refcnt;
                MOD_DEC_USE_COUNT;
        }
	printk(KERN_INFO "pda: pda_release() now closing remote device. \n");
        return err;
}


static struct file_operations pda_fops = {
	NULL,			/* lseek - default */
	block_read,		/* read - general block-dev read */
	block_write,		/* write - general block-dev write */
	NULL,			/* readdir - bad */
	NULL,			/* poll */
	NULL,			/* ioctl */
	NULL,			/* mmap */
	pda_open,		/* open */
	NULL,			/* flush */
	pda_release		/* release */
};

/*
 * And now the modules code and kernel interface.
 */
#ifdef MODULE
#define pda_init init_module
#endif

int __init pda_init(void) 
{
int i;
	if (register_blkdev(MAJOR_NR, "pda", &pda_fops)) {
		printk(KERN_WARNING "pda: Unable to get major number %d for pda device\n",
		       MAJOR_NR);
		return -EIO;
	}
#ifndef MODULE
	printk(KERN_INFO "pda: Generic PDA device driver Ver.0.0a2 (http://surf.to/zurk)\n");
	printk(KERN_INFO "pda: registered device at major %d.\n",MAJOR_NR);
#endif
//	pda_maxsectors[0]=1;
//	pda_hardsect[0]=1;
        blk_dev[MAJOR_NR].request_fn = DEVICE_REQUEST;
        for (i=0; i < MAX_PDA; i++) {
                memset(&pda_dev[i], 0, sizeof(struct pda_device));
                pda_dev[i].pda_number = i; }
        pda_sizes[0] = 1;
        pda_blksizes[0] = 1024;
        blk_size[MAJOR_NR] = pda_sizes;
        blksize_size[MAJOR_NR] = pda_blksizes;
//       max_sectors[MAJOR_NR] = pda_maxsectors;
//       hardsect_size[MAJOR_NR] = pda_hardsect;
	return 0;
}

#ifdef MODULE
void cleanup_module(void) 
{
	if (unregister_blkdev(MAJOR_NR, "pda") != 0)
		printk(KERN_WARNING "pda: cannot unregister blkdev\n");
}
#endif
